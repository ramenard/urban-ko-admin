name: Build & Push Frontend

on:
  push:
    branches: [staging, prod]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          username: welannn
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set docker image tag
        id: vars
        run: |
          if [ "${{ github.ref_name }}" = "prod" ]; then
            echo "TAG=production" >> $GITHUB_OUTPUT
          else
            echo "TAG=staging" >> $GITHUB_OUTPUT
          fi

      - uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            welannn/urban-ko-admin:${{ steps.vars.outputs.TAG }}
            welannn/urban-ko-admin:${{ github.sha }}

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-and-push]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify SSH secret exists
        run: |
          if [ -n "${{ secrets.VPS_DEPLOY_KEY }}" ]; then
            echo "‚úÖ VPS_DEPLOY_KEY secret is configured"
          else
            echo "‚ùå VPS_DEPLOY_KEY secret is missing"
          fi

      # La partie ci-dessous est comment√©e car nous ne disposons pas de VPS
      # Elle serait d√©comment√©e en production r√©elle

      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #       host: ${{ secrets.VPS_HOST }}
      #       username: ubuntu
      #       key: ${{ secrets.VPS_DEPLOY_KEY }}
      #       script: |
      #           cd /opt/urbanko
      #           git fetch origin
      #           git reset --hard origin/${{ github.ref_name }}
      #           docker compose --env-file .env.${{ github.ref_name == 'prod' && 'production' || 'staging' }} pull
      #           docker compose --env-file .env.${{ github.ref_name == 'prod' && 'production' || 'staging' }} up -d
      #           docker image prune -f

      - name: Deployment simulation
        run: |
          echo "üöÄ Deployment would execute the following commands on VPS:"
          echo "   cd /opt/urbanko"
          echo "   git fetch origin"
          echo "   git reset --hard origin/${{ github.ref_name }}"
          echo "   docker compose --env-file .env.${{ github.ref_name == 'prod' && 'production' || 'staging' }} pull"
          echo "   docker compose --env-file .env.${{ github.ref_name == 'prod' && 'production' || 'staging' }} up -d"
          echo "   docker image prune -f"
          echo ""
          echo "‚úÖ Deployment simulation complete (no VPS configured)"
